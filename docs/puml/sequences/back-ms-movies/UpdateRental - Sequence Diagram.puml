@startuml Update Rental
!theme plain
title Update Rental - Hexagonal Architecture Flow

actor Client
participant "RentalController\n(Input Adapter)" as Controller
participant "RentalUseCase\n(Domain Port)" as UseCase
participant "RentalMapper\n(Application Layer)" as Mapper
participant "RentalRepositoryPort\n(Domain Port)" as RepoPort
participant "RentalRepositoryAdapter\n(Output Adapter)" as RepoAdapter
participant "JpaRentalRepository\n(Infrastructure)" as JpaRepo
database "Database" as DB

Client -> Controller: PUT /rentals/{rentalId}
activate Controller

Controller -> UseCase: update(rentalId, UpdateRentalRequestContent)
activate UseCase
note right: UseCase is implemented by RentalService

UseCase -> RepoPort: findById(rentalId)
activate RepoPort
RepoPort -> RepoAdapter: findById(rentalId)
activate RepoAdapter
RepoAdapter -> JpaRepo: findById(rentalId)
activate JpaRepo
JpaRepo -> DB: SELECT * FROM rentals WHERE id = ?
DB --> JpaRepo: Optional<RentalDbo>
JpaRepo --> RepoAdapter: Optional<RentalDbo>
deactivate JpaRepo

alt Rental Found
    RepoAdapter -> Mapper: toDomain(RentalDbo)
    activate Mapper
    Mapper --> RepoAdapter: Rental
    deactivate Mapper
    
    RepoAdapter --> RepoPort: Optional<Rental>
    deactivate RepoAdapter
    RepoPort --> UseCase: Optional<Rental>
    deactivate RepoPort
    
    UseCase -> Mapper: updateEntityFromRequest(UpdateRentalRequestContent, Rental)
    activate Mapper
    Mapper --> UseCase: void (Rental updated)
    deactivate Mapper
    
    UseCase -> RepoPort: save(Rental)
    activate RepoPort
    RepoPort -> RepoAdapter: save(Rental)
    activate RepoAdapter
    
    RepoAdapter -> Mapper: toDbo(Rental)
    activate Mapper
    Mapper --> RepoAdapter: RentalDbo
    deactivate Mapper
    
    RepoAdapter -> JpaRepo: save(RentalDbo)
    activate JpaRepo
    JpaRepo -> DB: UPDATE rentals SET ... WHERE id = ?
    DB --> JpaRepo: RentalDbo
    JpaRepo --> RepoAdapter: RentalDbo
    deactivate JpaRepo
    
    RepoAdapter -> Mapper: toDomain(RentalDbo)
    activate Mapper
    Mapper --> RepoAdapter: Rental
    deactivate Mapper
    
    RepoAdapter --> RepoPort: Rental
    deactivate RepoAdapter
    RepoPort --> UseCase: Rental
    deactivate RepoPort
    
    UseCase -> Mapper: toUpdateResponse(Rental)
    activate Mapper
    Mapper --> UseCase: UpdateRentalResponseContent
    deactivate Mapper
    
    UseCase --> Controller: UpdateRentalResponseContent
    deactivate UseCase
    
    Controller --> Client: HTTP 200
    deactivate Controller

else Rental Not Found
    RepoAdapter --> RepoPort: Optional.empty()
    deactivate RepoAdapter
    RepoPort --> UseCase: Optional.empty()
    deactivate RepoPort
    
    UseCase --> Controller: NotFoundException("Rental not found")
    deactivate UseCase
    
    Controller --> Client: HTTP 404
    deactivate Controller
end

@enduml