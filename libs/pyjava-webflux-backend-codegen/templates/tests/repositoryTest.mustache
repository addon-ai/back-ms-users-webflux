package {{packageName}};

import {{basePackage}}.infrastructure.adapters.output.persistence.entity.{{entityName}}Dbo;
import {{basePackage}}.infrastructure.adapters.output.persistence.repository.Jpa{{entityName}}Repository;
import {{basePackage}}.domain.model.EntityStatus;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.data.r2dbc.DataR2dbcTest;
import reactor.test.StepVerifier;

import java.math.BigDecimal;
import java.util.UUID;
import java.time.Duration;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * Integration tests for Jpa{{entityName}}Repository.
 * 
 * @author {{author}}
 * @version {{version}}
 */
@DataR2dbcTest
class Jpa{{entityName}}RepositoryTest {

    @Autowired
    private Jpa{{entityName}}Repository {{entityVarName}}Repository;

    private {{entityName}}Dbo create{{entityName}}Dbo() {
        return {{entityName}}Dbo.builder()
{{#properties}}
{{#required}}
{{#isString}}
            .{{name}}("test-{{name}}")
{{/isString}}
{{#isEmail}}
            .{{name}}("test@example.com")
{{/isEmail}}
{{#isBoolean}}
            .{{name}}(true)
{{/isBoolean}}
{{#isInteger}}
            .{{name}}(1)
{{/isInteger}}
{{#isLong}}
            .{{name}}(1L)
{{/isLong}}
{{#isDouble}}
            .{{name}}(1.0)
{{/isDouble}}
{{#isBigDecimal}}
            .{{name}}(java.math.BigDecimal.valueOf(1.0))
{{/isBigDecimal}}
{{/required}}
{{/properties}}
            .status(EntityStatus.ACTIVE)
            .build();
    }

    @Test
    void findById_ShouldReturnEntity_WhenExists() {
        // Given
        {{entityName}}Dbo {{entityVarName}} = create{{entityName}}Dbo();
        {{entityName}}Dbo saved{{entityName}} = {{entityVarName}}Repository.save({{entityVarName}})
            .block(Duration.ofSeconds(5));

        // When
        {{entityName}}Dbo result = {{entityVarName}}Repository.findById(saved{{entityName}}.getId())
            .block(Duration.ofSeconds(5));

        // Then
        assertThat(result).isNotNull();
        assertThat(result.getId()).isEqualTo(saved{{entityName}}.getId());
    }

    @Test
    void save_ShouldPersistEntity() {
        // Given
        {{entityName}}Dbo {{entityVarName}} = create{{entityName}}Dbo();

        // When
        {{entityName}}Dbo saved{{entityName}} = {{entityVarName}}Repository.save({{entityVarName}})
            .block(Duration.ofSeconds(5));

        // Then
        assertThat(saved{{entityName}}.getId()).isNotNull();
        
        {{entityName}}Dbo found{{entityName}} = {{entityVarName}}Repository.findById(saved{{entityName}}.getId())
            .block(Duration.ofSeconds(5));
        assertThat(found{{entityName}}).isNotNull();
    }

    @Test
    void deleteById_ShouldRemoveEntity() {
        // Given
        {{entityName}}Dbo {{entityVarName}} = create{{entityName}}Dbo();
        {{entityName}}Dbo saved{{entityName}} = {{entityVarName}}Repository.save({{entityVarName}})
            .block(Duration.ofSeconds(5));

        // When
        {{entityVarName}}Repository.deleteById(saved{{entityName}}.getId())
            .block(Duration.ofSeconds(5));

        // Then
        {{entityName}}Dbo found{{entityName}} = {{entityVarName}}Repository.findById(saved{{entityName}}.getId())
            .block(Duration.ofSeconds(5));
        assertThat(found{{entityName}}).isNull();
    }

    @Test
    void existsById_ShouldReturnTrue_WhenEntityExists() {
        // Given
        {{entityName}}Dbo {{entityVarName}} = create{{entityName}}Dbo();
        {{entityName}}Dbo saved{{entityName}} = {{entityVarName}}Repository.save({{entityVarName}})
            .block(Duration.ofSeconds(5));

        // When
        Boolean exists = {{entityVarName}}Repository.existsById(saved{{entityName}}.getId())
            .block(Duration.ofSeconds(5));

        // Then
        assertThat(exists).isTrue();
    }

    @Test
    void existsById_ShouldReturnFalse_WhenEntityDoesNotExist() {
        // Given
        UUID nonExistentId = UUID.randomUUID();
        
        // When
        Boolean exists = {{entityVarName}}Repository.existsById(nonExistentId)
            .block(Duration.ofSeconds(5));

        // Then
        assertThat(exists).isFalse();
    }
}